# Тестирование RAG системы

## Быстрая проверка

### 1. Проверить статистику индексации

```bash
go run scripts/test_rag.go
```

Покажет:
- Сколько всего сообщений
- Сколько проиндексировано
- Процент готовности

### 2. Тестовый поиск

```bash
go run scripts/test_rag.go -query="ваш вопрос"
```

---

## Примеры запросов (на основе типичной истории киберспорт/крипто чата)

### Пример 1: Поиск по теме игр

```bash
go run scripts/test_rag.go -query="Какие игры обсуждали?"
```

**Что должно найти:**
- Сообщения с упоминаниями конкретных игр (CS:GO, Dota, Valorant, и т.д.)
- Обсуждения геймплея, стратегий
- Рекомендации по играм

### Пример 2: Поиск по криптовалютам

```bash
go run scripts/test_rag.go -query="Что говорили про биткоин?"
```

**Что должно найти:**
- Обсуждения цен, прогнозов
- Торговые стратегии
- Новости о крипте

### Пример 3: Технические проблемы

```bash
go run scripts/test_rag.go -query="Как исправить лаги в игре?"
```

**Что должно найти:**
- Советы по оптимизации
- Обсуждения проблем с производительностью
- Рекомендации по настройкам

### Пример 4: Поиск по конкретному событию

```bash
go run scripts/test_rag.go -query="Что обсуждали про последний турнир?"
```

**Что должно найти:**
- Обсуждения турниров, соревнований
- Результаты матчей
- Комментарии о командах/игроках

### Пример 5: Поиск мнений

```bash
go run scripts/test_rag.go -query="Что думают про новый патч?"
```

**Что должно найти:**
- Обсуждения обновлений игры
- Мнения о балансе
- Баг-репорты

---

## Настройка параметров поиска

### Top K (количество результатов)

```bash
# Получить только 3 самых релевантных результата
go run scripts/test_rag.go -query="вопрос" -top=3

# Получить 10 результатов для широкого контекста
go run scripts/test_rag.go -query="вопрос" -top=10
```

**Рекомендации:**
- `top=3-5`: для конкретных вопросов
- `top=5-10`: для широких тем
- `top=10+`: для исследовательских запросов

### Similarity Threshold (порог схожести)

```bash
# Только очень похожие результаты (строгий поиск)
go run scripts/test_rag.go -query="вопрос" -threshold=0.85

# Более широкий поиск (мягкий порог)
go run scripts/test_rag.go -query="вопрос" -threshold=0.6
```

**Рекомендации:**
- `0.85-1.0`: только очень релевантные (может ничего не найти)
- `0.75-0.85`: хороший баланс (по умолчанию 0.7-0.8)
- `0.6-0.75`: широкий поиск (может быть шум)
- `0.4-0.6`: очень широкий (много нерелевантного)

---

## Тестирование в Telegram

### Шаг 1: Убедись что RAG включен

В `.env`:
```
RAG_ENABLED=true
```

### Шаг 2: Отправь вопрос боту

Просто упомяни бота в чате с вопросом:

```
@cybersportsmeny_llm_bot Какие игры мы обсуждали на этой неделе?
```

### Шаг 3: Проверь логи

Бот должен показать в логах:

```json
{"level":"info","component":"rag","query":"Какие игры мы обсуждали...","results_count":5}
{"level":"info","component":"llm","context_added":true,"rag_enabled":true}
```

---

## Проверка качества RAG

### Признаки хорошей работы RAG:

✅ **Бот упоминает конкретные факты из истории чата:**
```
Пользователь: Что мы обсуждали про Dota?
Бот: В чате обсуждали новый патч 7.35. @username писал, что Invoker теперь
     слишком силен, а @another_user рекомендовал попробовать Phantom Assassin.
```

✅ **Бот помнит предыдущие обсуждения:**
```
Пользователь: Какие настройки мне советовали?
Бот: @username советовал выставить чувствительность мыши 800 DPI и уменьшить 
     графику до средних настроек для лучшего FPS.
```

✅ **Бот ссылается на конкретных людей и даты:**
```
Бот: По поводу этого вопроса @user_123 писал 2 дня назад, что...
```

### Признаки плохой работы RAG:

❌ **Бот дает общие ответы без упоминания истории:**
```
Пользователь: Что обсуждали про игры?
Бот: Игры - это интерактивная форма развлечения... [общая информация]
```

❌ **Бот не находит очевидно релевантные сообщения:**
```
# В чате есть 10 сообщений про Bitcoin
Пользователь: Что говорили про биткоин?
Бот: Я не нашел информации об этом в истории чата.
```

❌ **Бот выдает нерелевантные результаты:**
```
Пользователь: Как настроить мышку?
Бот: В чате обсуждали курс Ethereum... [нерелевантно]
```

---

## Отладка проблем

### Проблема: "Ничего не находится"

**Причина 1:** Мало проиндексированных сообщений

```sql
-- Проверь в Supabase
SELECT * FROM rag_statistics;
```

Если `indexed_percentage < 10%`, нужно доиндексировать:
```bash
make embeddings
```

**Причина 2:** Слишком высокий threshold

Попробуй понизить:
```bash
go run scripts/test_rag.go -query="вопрос" -threshold=0.6
```

**Причина 3:** Запрос слишком специфичный

Попробуй более общий запрос:
```bash
# Вместо
go run scripts/test_rag.go -query="Что писал @user_123 про патч 7.35 в Dota 2?"

# Попробуй
go run scripts/test_rag.go -query="Обсуждение Dota 2"
```

### Проблема: "Находит нерелевантное"

**Причина:** Слишком низкий threshold

Повысь порог:
```bash
go run scripts/test_rag.go -query="вопрос" -threshold=0.8
```

Или уменьши top_k:
```bash
go run scripts/test_rag.go -query="вопрос" -top=3
```

### Проблема: "Бот не использует RAG в Telegram"

Проверь:

1. **RAG включен в конфиге**:
```bash
grep RAG_ENABLED .env
# Должно быть: RAG_ENABLED=true
```

2. **Есть проиндексированные сообщения**:
```sql
SELECT COUNT(*) FROM chat_messages WHERE indexed = true;
```

3. **Бот перезапущен после изменений**:
```bash
docker-compose restart
```

4. **Логи бота**:
```bash
docker-compose logs -f telegram-llm-bot | grep -i rag
```

---

## Примеры из реального чата "Киберспортсмены | Криптория"

### Тест 1: Общая тема

```bash
go run scripts/test_rag.go -query="О чем чаще всего говорили в чате?"
```

**Ожидается:**
- Топ 5-10 самых обсуждаемых тем
- Микс киберспорта и крипты

### Тест 2: Конкретный пользователь

```bash
go run scripts/test_rag.go -query="Что писал Артем?"
```

**Ожидается:**
- Сообщения от пользователя с именем "Артем" или username содержащим "artem"

### Тест 3: Временной запрос

```bash
go run scripts/test_rag.go -query="Последние новости"
```

**Ожидается:**
- Недавние сообщения с новостями/анонсами

### Тест 4: Проблемы/вопросы

```bash
go run scripts/test_rag.go -query="Какие проблемы обсуждали?"
```

**Ожидается:**
- Сообщения с вопросами, жалобами, проблемами

---

## SQL запросы для проверки данных

### Проверить индексацию

```sql
-- Статистика
SELECT * FROM rag_statistics;

-- Последние проиндексированные
SELECT id, message_text, created_at, indexed_at 
FROM chat_messages 
WHERE indexed = true 
ORDER BY indexed_at DESC 
LIMIT 10;

-- Непроиндексированные
SELECT COUNT(*) as unindexed_count
FROM chat_messages 
WHERE indexed = false;
```

### Проверить векторы

```sql
-- Проверить что embeddings не NULL
SELECT COUNT(*) as with_embeddings
FROM chat_messages 
WHERE embedding IS NOT NULL;

-- Размерность векторов (должна быть 768)
SELECT id, vector_dims(embedding) as dims
FROM chat_messages 
WHERE embedding IS NOT NULL
LIMIT 5;
```

### Тестовый поиск напрямую в БД

```sql
-- Найти похожие сообщения (нужно вставить вектор вручную)
SELECT 
    message_text,
    username,
    created_at,
    1 - (embedding <=> '[0.1, 0.2, ...]'::vector) as similarity
FROM chat_messages
WHERE indexed = true
ORDER BY similarity DESC
LIMIT 5;
```

---

## Makefile команды для тестирования

Добавь в `Makefile`:

```makefile
# Test RAG search
test-rag:
	@if [ -z "$(QUERY)" ]; then \
		go run scripts/test_rag.go; \
	else \
		go run scripts/test_rag.go -query="$(QUERY)" -top=$(or $(TOP),5) -threshold=$(or $(THRESHOLD),0.7); \
	fi

# Test with examples
test-rag-examples:
	@echo "Testing RAG with example queries..."
	@go run scripts/test_rag.go -query="Какие игры обсуждали?" -top=3
	@echo "\n---\n"
	@go run scripts/test_rag.go -query="Что говорили про крипту?" -top=3
```

Использование:
```bash
make test-rag QUERY="ваш вопрос"
make test-rag QUERY="вопрос" TOP=10 THRESHOLD=0.8
make test-rag-examples
```

---

**Создано:** 2025-11-20  
**Автор:** Cursor AI Agent

